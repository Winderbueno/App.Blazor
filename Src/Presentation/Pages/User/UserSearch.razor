@using Application.Dtos.User
@using Domain.Enums.User
@using Presentation.Pages.User.Components

@page "/users"
@page "/users/search"
@attribute [Authorize]
@inject IUserService userService

<Container FlexColumn NoWrap>

    <Container FlexJustify="space-between"
               FlexAlign="center">
        <h1>@t["user.feature.search"]</h1>
        <Link Button Icon="plus"
               Route="users/create">@t["action.create"]</Link>
     </Container>

     <Card>
         <UserSearchForm Form=form OnFormChange=OnFormChange />

         @if (userIds != null)
        {
            <InfiniteScroller @ref="infiniteScroller" OnLoad=OnLoad>
                <Container Grid PaddingInline=Size.Largest
                            GridColumns="repeat(auto-fit, minmax(20rem, 1fr))"
                            MobileChildWidth="20rem">
                     @foreach (int userId in userIds)
                    {
                        <UserCard UserId=userId OnUserDelete=OnUserDelete />
                    }
                </Container>
            </InfiniteScroller>
        }
    </Card>

</Container>

@code {
    [CascadingParameter]
    public ErrorHandler? ErrorHandler { get; set; }

    private UserSearchFormDto form = new();
    private IEnumerable<int>? userIds = null;
    private InfiniteScroller? infiniteScroller;

    protected override async Task OnInitializedAsync()
    {
        form.PageNumber = 1;
        userIds = await SearchAsync();
    }

    // This is necessary for the infinite scroller _module not to be null on first load
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) userIds = await SearchAsync();
    }

    private async void OnFormChange(UserSearchFormDto form)
    {
        await infiniteScroller!.ActivateLoad();
        this.form = form;
        this.form.PageNumber = 1;
        userIds = await SearchAsync();
        StateHasChanged();
    }

    private void OnUserDelete(int id)
    {
        userIds = userIds is not null ? userIds.Where(x => x != id) : userIds;
        StateHasChanged();
    }

    private async Task OnLoad()
    {
        form.PageNumber++;
        IEnumerable<int> pageIds = await SearchAsync();
        if (pageIds.Any()) this.userIds = this.userIds!.Concat(pageIds).ToList();

        // Search ended
        if (pageIds.Count() < form.PageSize) infiniteScroller!.DeactivateLoad();
    }

    private async Task<IEnumerable<int>> SearchAsync()
    {
        form.PageSize = 8;

        var userIds = new List<int>();
        try
        {
            userIds = (await userService.SearchAsync(form)).ToList();
        }
        catch (Exception e) { ErrorHandler!.ProcessError(e); }

        return userIds;
    }
}